<ion-header [translucent]="true">
  <ion-toolbar color="primary"> 
    <ion-title>Mini Feed</ion-title>
    
    <ion-buttons slot="start">
      <ion-button (click)="goTo('friends')">
        <ion-icon name="people-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="goTo('profile')">
        <ion-icon name="person-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    
    <ion-buttons slot="end">
      <ion-button (click)="goTo('create-post')">
        <ion-icon name="add-circle-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="logout()">
        <ion-icon name="log-out-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="ion-text-center ion-padding" *ngIf="isLoading">
    <ion-spinner></ion-spinner>
    <p>Cargando posts...</p>
  </div>
  
  <!-- Iteramos sobre la lista de posts -->
  <ion-list *ngFor="let post of posts">
    <ion-card>
      <ion-item lines="none">
        <ion-avatar slot="start">
          <!-- Avatar del usuario con fallback -->
          <img alt="User Avatar" [src]="post.user.avatar_url || 'https://ionicframework.com/docs/img/demos/avatar.svg'" />
        </ion-avatar>
        <ion-label>
          <h2>{{ post.user.name }}</h2>
          <p>{{ post.created_at | date:'medium' }}</p>
        </ion-label>
      </ion-item>
      
      <img alt="Post Image" 
           [src]="post.image_url && post.image_url.startsWith('http') ? 
                  post.image_url : 
                  (apiService.apiUrl.replace('/api', '/storage/') + post.image_url)" 
           class="post-image"
           *ngIf="post.image_url">
      <!-- NOTA: post.image_url es necesario para que el <img> ni siquiera aparezca si no hay foto -->

      <ion-card-content>
        <p class="ion-padding-bottom">
          <strong>{{ post.likes_count || 0 }}</strong> likes
        </p>
        <p><strong>{{ post.user.username }}</strong> {{ post.caption }}</p>
        
        <ion-button 
          fill="clear" 
          size="small"
          [color]="post.is_liked ? 'danger' : 'medium'" 
          (click)="handleLike(post)">
          <ion-icon [name]="post.is_liked ? 'heart' : 'heart-outline'"></ion-icon>
        </ion-button>
        
        <ion-button fill="clear" size="small" routerLink="/post-detail/{{post.id}}">
          <ion-icon name="chatbubble-outline"></ion-icon>
          Ver comentarios
        </ion-button>
      </ion-card-content>
    </ion-card>
  </ion-list>
  
  <ion-infinite-scroll (ionInfinite)="loadMore($event)" [disabled]="!canLoadMore">
    <ion-infinite-scroll-content loadingText="Cargando mÃ¡s posts..."></ion-infinite-scroll-content>
  </ion-infinite-scroll>
</ion-content>